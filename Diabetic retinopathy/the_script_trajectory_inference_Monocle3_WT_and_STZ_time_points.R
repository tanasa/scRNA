
###########################################################################################################
###########################################################################################################
###########################################################################################################
###########################################################################################################

# integrated.integration.SEURAT.reciprocalPCA.RData.after.plotly3D.RData
# module load r/4.0.3

#####################################################################################################################################  MONOCLE3
#####################################################################################################################################  MONOCLE3

set.seed(423)

library(Cairo)
options(bitmapType='cairo')
library(sf)
# library(rgl)
library(patchwork)

library(monocle3)
library(plotly)

library(ggplot2)
library(dplyr)
library(edgeR)

library(Seurat)
library(SeuratData)
library(SeuratWrappers)

#library(conos)
#library(liger)
#library(harmony)

library(cowplot)
library(Matrix)
library(gridExtra)

library(future)
library(future.apply)
library(tradeSeq)

library("ComplexHeatmap")
library("pheatmap")
library("circlize")
library("RColorBrewer")
library("grid")
library("ggplot2")

# library("ClusterExperiment") 
library("circlize")
library("pheatmap")
library(ComplexHeatmap)
library(RColorBrewer)

plan("multiprocess", workers = 8)
options(future.globals.maxSize = 64000 * 1024^2)

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### # testing how RDATA reading works  # in another SHELL !!!
#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### # perhaps we can start the script here
##################################################################################################################################### # and redo the UMAP on 3 D COMPONENTS !!!!!!!!!!!!!!!!!!!

setwd("/oak/stanford/scg/lab_suiwang/")
load("./integrated.integration.SEURAT.reciprocalPCA.RData.after.plotly3D.RData")

NAME = "MONOCLE.figs"

##################### the NAME of the OBJECT that countains all the DATA is : samples.combined.list.combined

str(samples.combined.list.combined)
samples.combined.list.combined@meta.data

#####################################################################################################################################
##################################################################################################################################### PRINTING the META.DATA

### THE OBJECT contains all the CLUSTERS, including MULLER GLIA, we do print META.DATA

write.table(as.data.frame(samples.combined.list.combined@meta.data),
            file=paste(NAME, "the meta.data.txt", sep="."), sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### READING THE GENES that we wanna display
##################################################################################################################################### EACH CLUSTER

LIST.KNOWN.MARKERS = read.delim("a.LIST.MARKERS.RETINA.SUI.rat.txt", header=T, sep="\t", stringsAsFactors=F) 

# head(LIST.KNOWN.MARKERS)
#   CELL MARKER
# LIST.KNOWN.MARKERS$CELL
# LIST.KNOWN.MARKERS$MARKER

#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### COLORS depending on the number of SAMPLES
##################################################################################################################################### in SUI's data we have 10 SAMPLES !!!!!!!! 

COLOR_PALETTE = c("red", "orange", "yellow", "pink", "green", "cyan", "blue", "purple", "magenta", "brown")

#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################

Idents(samples.combined.list.combined) = "seurat_clusters"

head(as.data.frame(Idents(samples.combined.list.combined)))
table(Idents(samples.combined.list.combined))               ############# IT SHOWS the NUMBER of CELLS in EACH CLUSTER 

THE_CLUSTERS = sort(unique((as.data.frame(Idents(samples.combined.list.combined))[,1])))
length(THE_CLUSTERS)

# length(THE_CLUSTERS)
# [1] 48
# THE_CLUSTERS
# [1]  0  1  2  3  4  5  6  7  8  9  10 11 12 13 14 15 16 17 18 19 20 21 22 23 24
# [26] 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47

################################################################################################################
################################################################################################################
################################################################################################################
################################################################################################################
################################################################################################################# VERY IMPORTANT !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
################################################################################################################
################################################################################################################
################################################################################################################
################################################################################################################
################################################################################################################ to write a LOOP that goes through each CLUSTER !!!!
################################################################################################################
################################################################################################################ and not only through MULLER GLIA !!!!!
# for (i in 1:length(THE_CLUSTERS) ) {
# NUMBER_CLUSTER = i-1
# print(NUMBER_CLUSTER) }

################################################################################################################ and to add the NUMBER_CLUSTER to the NAMES of the OUTPUT FILES
################################################################################################################
################################################################################################################
################################################################################################################ set NUMBER_CLUSTER = 3 !!!it is MULLER GLIA !!!

## if we wanna work only with MG : NUMBER_CLUSTER = 3 ## !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
### if we wanna LOOP through all the CLUSTERS, we keep the for LOOP !!!!!

NUMBER_CLUSTER = 3

# for (i in 1:length(THE_CLUSTERS) )
# {
#   NUMBER_CLUSTER = i-1
#  print(NUMBER_CLUSTER)

################################################################################################################
################################################################################################################
################################################################################################################ now using an OBJECT that is called samples.combined.list.combined.CLUSTER
################################################################################################################

samples.combined.list.combined.CLUSTER = subset(samples.combined.list.combined, idents = NUMBER_CLUSTER)
table(Idents(samples.combined.list.combined.CLUSTER))
dim((samples.combined.list.combined.CLUSTER))

# rm(samples.combined.list.combined)
# to add to the name of the files :
# "CLUSTER", NUMBER_CLUSTER,

write.table(as.data.frame(samples.combined.list.combined.CLUSTER@meta.data),
            file=paste(NAME, "the meta.data.CLUSTER3.txt", sep="."), sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

################################################################################################################
################################################################################################################
################################################################################################################

# table(Idents(samples.combined.list.combined.CLUSTER))
# 2
# 1938
# dim((samples.combined.list.combined.CLUSTER))   #############there are 25399 GENES and 1938 CELLS !!!!!!!!!!!!
# [1] 25399  1938

###################################################################################################################################
###################################################################################################################################
################################################################################################################
################################################################################################################
################################################################################################################
################################################################################################################ to convert to MONOCLE3
################################################################################################################
################################################################################################################ MONOCLE 3 !!!!!!!!

dim(as.data.frame(samples.combined.list.combined.CLUSTER@assays$RNA@counts))
dim(as.data.frame(samples.combined.list.combined.CLUSTER@meta.data))

##################################################################### to print again the ROWNAMES :
##################################################################### in order to include GENE SHORT NAME :

z = as.data.frame(rownames(samples.combined.list.combined.CLUSTER@assays$RNA@counts))
z$gene = z[ ,1]

z = as.data.frame(z)
colnames(z)[1] = "gene_short_name"

rownames(z) = z$gene
dim(z) # 25399

#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### to convert into a MONOCLE3 object
#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### cds = cds

cds <- new_cell_data_set(expression_data = as.matrix(samples.combined.list.combined.CLUSTER@assays$RNA@counts),
                         cell_metadata = as.data.frame(samples.combined.list.combined.CLUSTER@meta.data),
                         gene_metadata = as.data.frame(z))

str(cds)

colnames(colData(cds))

rowData(cds)$gene_short_name = rowData(cds)@rownames
rowData(cds)$gene = rowData(cds)@rownames

head(rowData(cds))
head(colData(cds))

#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################

cds <- estimate_size_factors(cds)   #### Aligning cells by using Batchelor.

cds <- preprocess_cds(cds, method = "PCA")

cds <- align_cds(cds, alignment_group = factor("orig.ident"))

cds <- reduce_dimension(cds, preprocess_method = "PCA",
                             reduction_method = "UMAP",
                             max_components = 3)              ############################################################### for 3D visualization !!!!

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################

cds@int_colData  
cds@rowRanges   
cds@colData     

cds@int_colData@listData$reducedDims$pca  = cds@int_colData@listData$reducedDims$PCA  ### IMPORTANT
cds@int_colData@listData$reducedDims$tsne = cds@int_colData@listData$reducedDims$TSNE ### IMPORTANT
cds@int_colData@listData$reducedDims$umap = cds@int_colData@listData$reducedDims$UMAP ### IMPORTANT

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
########################################################################################################################################################## plotting before CLUSTERING
########################################################################################################################################################## and LEARNING the TRAJECTORY !!!
##########################################################################################################################################################
##########################################################################################################################################################
########################################################################################################################################################## it is only a NAME..fig 10 !!

plot_cells(cds,
           color_cells_by = "orig.ident",
           label_cell_groups = FALSE,
           label_groups_by_cluster=FALSE,
           cell_size = 1)
ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure10.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.orig.ident.png", sep="."), width=40, height=40, units = "cm")

plot_cells(cds,
           color_cells_by = "seurat_clusters",
           label_cell_groups = FALSE,
           label_groups_by_cluster=FALSE,
           cell_size = 1)
ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure10.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.seurat_clusters.png", sep="."), width=40, height=40, units = "cm")

plot_cells(cds,
           color_cells_by = "celltype",
           label_cell_groups = FALSE,
           label_groups_by_cluster=FALSE,
           cell_size = 1)
ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure10.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.cell.type.png", sep="."), width=40, height=40, units = "cm")

plot_cells(cds,
           color_cells_by = "celltype.stim",
           label_cell_groups = FALSE,
           label_groups_by_cluster=FALSE,
           cell_size = 1)
ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure10.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.celltype.stim.png", sep="."), width=40, height=40, units = "cm")

#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################

cds_plot_obj_a <- plot_cells_3d(cds, color_cells_by="orig.ident",
                                     color_palette = COLOR_PALETTE,
                                     cell_size = 50)
htmlwidgets::saveWidget(cds_plot_obj_a,
                        paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure10.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.in.3D", "SEURAT.ORIG.IDENT", "before.monocle3.cluster.html", sep="."))


cds_plot_obj_b <- plot_cells_3d(cds, color_cells_by="seurat_clusters",  
                                      cell_size = 50)
htmlwidgets::saveWidget(cds_plot_obj_b,
                        paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure10.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.in.3D", "SEURAT.CLUSTERS", "before.monocle3.cluster.html", sep="."))


cds_plot_obj_c <- plot_cells_3d(cds, color_cells_by="celltype",  
                                      cell_size = 50)
htmlwidgets::saveWidget(cds_plot_obj_c,
                        paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure10.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.in.3D", "SEURAT.CELLTYPE", "before.monocle3.cluster.html", sep="."))


cds_plot_obj_d <- plot_cells_3d(cds, color_cells_by="celltype.stim",
                                     color_palette = COLOR_PALETTE,
                                     cell_size = 50)
htmlwidgets::saveWidget(cds_plot_obj_d,
                        paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure10.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.in.3D", "SEURAT.CELLTYPE.STIM", "before.monocle3.cluster.html", sep="."))

########################################################################################################################################################## in order to save MEMORY !!!!!!!!!!!!

rm(cds_plot_obj_a)
rm(cds_plot_obj_b)
rm(cds_plot_obj_c)
rm(cds_plot_obj_d)

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
########################################################################################################################################################## cluster_cells(cds)

cds <- cluster_cells(cds)  

head(cds@preprocess_aux$gene_loadings)
str(cds@clusters@listData$UMAP)

head(as.data.frame(monocle3::clusters(cds)))
head(as.data.frame(monocle3::partitions(cds)))

unique(as.data.frame((monocle3::clusters(cds)))[,1]) # [1] 1 2 3 4 5
unique(as.data.frame(monocle3::partitions(cds))[,1]) # [1] 1

##########################################################################################################################################################
########################################################################################################################################################## clusters
########################################################################################################################################################## and
########################################################################################################################################################## partitions

colData(cds)$cluster = monocle3::clusters(cds)

colData(cds)$partition = monocle3::partitions(cds)

#######################################################################################################
####################################################################################################### printing for VERIFICATION !!!!!!!!!!!!!!!!!

write.table(as.data.frame(monocle3::clusters(cds)),
                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure11.before.learn_graph", "META.DATA", "in.MONOCLE3.clusters(cds).txt", sep="."),
                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

write.table(as.data.frame(monocle3::partitions(cds)),
                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure11.before.learn_graph", "META.DATA", "in.MONOCLE3.partitions(cds).txt", sep="."),
                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

write.table(as.data.frame(colData(cds)),
                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure11.before.learn_graph", "META.DATA", "in.MONOCLE3.colData.again.txt", sep="."),
                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

#######################################################################################################
#######################################################################################################

p1 <- plot_cells(cds, color_cells_by = "cluster", show_trajectory_graph = FALSE, group_label_size = 5, cell_size = 1)
p2 <- plot_cells(cds, color_cells_by = "partition", show_trajectory_graph = FALSE, group_label_size = 5, cell_size = 1)

wrap_plots(p1, p2)
ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure12.samples.combined.MONOCLE3",  "PLOT", "CLUSTERS.and.PARTITIONS.png", sep="."), width=40, height=40, units = "cm")

#######################################################################################################
#######################################################################################################

plot_cells(cds, color_cells_by = "cluster",
                label_cell_groups = FALSE,
                label_groups_by_cluster = FALSE,
                show_trajectory_graph = FALSE,
                group_label_size = 5,
                cell_size = 1)
ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure12.samples.combined.MONOCLE3",  "PLOT", "CLUSTERS.MONOCLE3.png", sep="."),
       width=40, height=40, units = "cm")

#######################################################################################################
#######################################################################################################

plot_cells(cds, color_cells_by = "partition",
                label_cell_groups = FALSE,
                label_groups_by_cluster = FALSE,
                show_trajectory_graph = FALSE,
                group_label_size = 5,
                cell_size = 1)
ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure12.samples.combined.MONOCLE3",  "PLOT", "PARTITIONS.MONOCLE3.png", sep="."),
      width=40, height=40, units = "cm")

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
########################################################################################################################################################## learn_graph(cds)

cds <- learn_graph(cds)

plot_cells(cds, reduction_method = "UMAP", color_cells_by = "orig.ident")
ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure12", "PARTITIONS.MONOCLE3.png", sep="."), width=40, height=40, units = "cm")

##########################################################################################################################################################
##########################################################################################################################################################
################################## setting the ORIGIN of the TRAJECTORY !

get_earliest_principal_node <- function(cds, time_bin="WT.1M"){

  cell_ids <- which(colData(cds)[, "orig.ident"] == time_bin)
 
  closest_vertex <- cds@principal_graph_aux[["UMAP"]]$pr_graph_cell_proj_closest_vertex
  closest_vertex <- as.matrix(closest_vertex[colnames(cds), ])
  root_pr_nodes  <- igraph::V(principal_graph(cds)[["UMAP"]])$name[as.numeric(names(which.max(table(closest_vertex[cell_ids,]))))]
 
  root_pr_nodes
}

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
########################################################################################################################################################## order_cells(cds)

cds <- order_cells(cds, reduction_method = "UMAP",
                        root_pr_nodes = get_earliest_principal_node(cds))

colData(cds)$pseudotime = monocle3::pseudotime(cds)

head(as.data.frame(colData(cds)$pseudotime))

plot_cells(cds, color_cells_by = "pseudotime",
           label_cell_groups = FALSE,
           label_leaves = FALSE,
           label_branch_points = FALSE, graph_label_size = 2)

#### !!!! here we did make a change !! and did add THIS FIGURE !!!
ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure12", "PARTITIONS+.MONOCLE3.png", sep="."), width=40, height=40, units = "cm")


##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
########################################################################################################################################################## DISPLAYS
##########################################################################################################################################################
########################################################################################################################################################## DISPLAYS
########################################################################################################################################################## also in 3D
##########################################################################################################################################################
##########################################################################################################################################################

plot_cells(cds,
           color_cells_by = "orig.ident",

           label_cell_groups = FALSE,
           label_groups_by_cluster=FALSE,

           label_roots = TRUE,
           label_leaves= TRUE,
           label_branch_points=TRUE,

           graph_label_size = 5, cell_size = 1.5)

ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure14.samples.combined.MONOCLE3", "PLOT.in.3D", "ORIG.IDENT", "png", sep="."), width=40, height=40, units = "cm")

############################################################################# in 3D !!!!!!!!!!!!!!!!
##########################################################################################################################################################
############################################################################# to use SAVE WIDGET !!!

cds_plot_obj1 <- plot_cells_3d(cds, color_cells_by="orig.ident",
                                    color_palette = COLOR_PALETTE,
                                    cell_size = 50)

htmlwidgets::saveWidget(cds_plot_obj1,
                        paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure14.samples.combined.MONOCLE3", "PLOT.in.3D", "ORIG.IDENT", "html", sep="."))

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################

plot_cells(cds,
           color_cells_by = "seurat_clusters",

           label_cell_groups = FALSE,
           label_groups_by_cluster=FALSE,

           label_roots = TRUE,
           label_leaves=TRUE,
           label_branch_points=TRUE,

           graph_label_size = 5, cell_size = 1.5)

ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure14.samples.combined.MONOCLE3", "PLOT.in.3D", "seurat_clusters", "png", sep="."), width=40, height=40, units = "cm")

############################################################################# in 3D !!!!!!!!!!!!!!!!
##########################################################################################################################################################
############################################################################# to use SAVE WIDGET !!!

cds_plot_obj2 <- plot_cells_3d(cds, color_cells_by="seurat_clusters",
                                    cell_size = 50)

htmlwidgets::saveWidget(cds_plot_obj2,
                        paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure14.samples.combined.MONOCLE3", "PLOT.in.3D", "seurat_clusters", "html", sep="."))

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################

plot_cells(cds,
           color_cells_by = "cluster",

           label_cell_groups = FALSE,
           label_groups_by_cluster=FALSE,

           label_roots = TRUE,
           label_leaves= TRUE,
           label_branch_points=TRUE,

           graph_label_size = 5, cell_size = 1.5)

ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure14.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.in.3D", "CLUSTER", "png", sep="."), width=40, height=40, units = "cm")

############################################################################# in 3D !!!!!!!!!!!!!!!!
##########################################################################################################################################################
############################################################################# to use SAVE WIDGET !!!

cds_plot_obj3 <- plot_cells_3d(cds, color_cells_by="cluster",
                                    cell_size = 50)
 
htmlwidgets::saveWidget(cds_plot_obj3,
                        paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure14.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.in.3D", "CLUSTER", "html", sep="."))

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################

plot_cells(cds,
           color_cells_by = "partition",

           label_cell_groups = FALSE,
           label_groups_by_cluster=FALSE,

           label_roots = TRUE,
           label_leaves= TRUE,
           label_branch_points=TRUE,

           graph_label_size = 5, cell_size = 1.5)

ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure14.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.in.3D", "PARTITION", "png", sep="."), width=40, height=40, units = "cm")

############################################################################# in 3D !!!!!!!!!!!!!!!!
##########################################################################################################################################################
############################################################################# to use SAVE WIDGET !!!

cds_plot_obj4 <- plot_cells_3d(cds, color_cells_by="partition",
                                    cell_size = 50)

htmlwidgets::saveWidget(cds_plot_obj4,
                        paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure14.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.in.3D", "PARTITION", "html", sep="."))

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################

plot_cells(cds,
           color_cells_by = "pseudotime",

           label_cell_groups = FALSE,
           label_groups_by_cluster=FALSE,

           label_roots = TRUE,
           label_leaves= TRUE,
           label_branch_points=TRUE,

           graph_label_size = 5, cell_size = 1.5)

ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure14.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.in.3D", "PSEUDOTIME", "png", sep="."), width=40, height=40, units = "cm")

############################################################################# in 3D !!!!!!!!!!!!!!!!
##########################################################################################################################################################
############################################################################# to use SAVE WIDGET !!!

cds_plot_obj5 <- plot_cells_3d(cds, color_cells_by = "pseudotime",
                                    cell_size = 50)

htmlwidgets::saveWidget(cds_plot_obj5,
                        paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure14.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.in.3D", "PSEUDOTIME", "html", sep="."))

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################

plot_cells(cds,
           color_cells_by = "celltype.stim",

           label_cell_groups = FALSE,
           label_groups_by_cluster=FALSE,

           label_roots = TRUE,
           label_leaves= TRUE,
           label_branch_points=TRUE,

           graph_label_size = 5, cell_size = 1.5)

ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure14.samples.combined.MONOCLE3",  "PLOT.by.MONOCLE3.in.3D", "celltype.stim", "png", sep="."), width=40, height=40, units = "cm")

############################################################################# in 3D !!!!!!!!!!!!!!!!
##########################################################################################################################################################
############################################################################# to use SAVE WIDGET !!!

cds_plot_obj6 <- plot_cells_3d(cds, color_cells_by="celltype.stim",
                                    color_palette = COLOR_PALETTE,
                                    cell_size = 50)

htmlwidgets::saveWidget(cds_plot_obj6,
                        paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure14.samples.combined.MONOCLE3", "PLOT.by.MONOCLE3.in.3D", "celltype.stim", "html", sep="."))

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

# to save on MEMORY !!!!

rm(cds_plot_obj1)
rm(cds_plot_obj2)
rm(cds_plot_obj3)
rm(cds_plot_obj4)
rm(cds_plot_obj5)
rm(cds_plot_obj6)

gc()

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##################################################################################################################################### DIFFERENTIAL PROGRESSION
#####################################################################################################################################
##################################################################################################################################### DIFFERENTIAL PROGRESSION

# FIT_MODELS

#     fit_models(
#       cds,
#       model_formula_str,
#       expression_family = "quasipoisson",
#       reduction_method = "UMAP",
#       cores = 1,
#       clean_model = TRUE,
#       verbose = TRUE

# GRAPH_TEST

# graph_test(
#       cds,
#       neighbor_graph = c("knn", "principal_graph"),
#       reduction_method = "UMAP",
#       k = 25,
#       method = c("Moran_I"),
#       alternative = "greater",
#       expression_family = "quasipoisson",
#       cores = 1,
#       verbose = TRUE

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### possibly to include these in a separate function that we are going to source ?
#####################################################################################################################################
##################################################################################################################################### FIT_MODELS
#####################################################################################################################################
##################################################################################################################################### 
#####################################################################################################################################
##################################################################################################################################### for NOW, we can use in the script only the GRAPH_TEST !!!!!!!
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

# gene_fits <- fit_models(cds, model_formula_str = "~orig.ident", cores=7)

# dim(gene_fits)

# table(gene_fits$status)

######################################################################## 
########################################################################

# fit_coefs <- coefficient_table(gene_fits)

# dim(fit_coefs)
# table(fit_coefs$status)
# table(fit_coefs$term)

########################################################################
########################################################################

# orig.ident_time_terms <- fit_coefs %>% filter(term == "orig.identSTZ.5M") 
# dim(orig.ident_time_terms)

########################################################################
########################################################################

# orig.ident_time_terms <- orig.ident_time_terms %>% mutate(q_value = p.adjust(p_value))

# unique(orig.ident_time_terms$term)                                 

# as.data.frame(table(orig.ident_time_terms$q_value))

# dim(orig.ident_time_terms %>% filter (q_value < 0.05)) # 425 14

##### sig_genes <- orig.ident_time_terms %>% filter(q_value < 0.05)
##### it has a very complex structure :)

# sig_genes <- orig.ident_time_terms %>% filter(q_value < 0.05) %>% pull(gene_short_name)

# write.table(as.data.frame(sig_genes),
#                        file=paste(NAME, "figure15.the.list.of.DE.genes", "from.MONOCLE3.using.FIT_MODELS.txt", sep="."),
#                        sep="\t", quote=FALSE, col.names = FALSE, row.names = TRUE)

########################################################################
######################################################################## to make the DOTPLOTS of the TOP GENES that are DEG (TOP 10)
########################################################################

# sig_genes_top10 = as.data.frame(sig_genes)$sig_genes[1:10]

# try(
# plot_genes_by_group(cds,
#                    group_cells_by = "orig.ident",
#                    markers = sig_genes_top10) +
#                    theme(axis.text.x=element_text(angle=45, hjust=1))
# )

# try(
# ggsave(paste(NAME, "figure15.samples.combined.MONOCLE3",  "FIT.MODELS", "PLOT.display.DOT.PLOT.MARKERS", "png", sep="."), width=30, height=30, units = "cm")#
# )

########################################################################
######################################################################## to make the VIOLINPLOTS of the TOP GENES that are DEG (TOP 10)
########################################################################

# for (i in 1:length(sig_genes_top10))
# {
#    GENE = sig_genes_top10[i]
#
#    if (GENE %in% rowData(cds)$gene)
#    {
#      cds_subset <- cds[rowData(cds)$gene_short_name %in% GENE,]
#
#      plot_genes_violin(cds_subset,
#                 group_cells_by="orig.ident", ncol=2) +
#                 theme(axis.text.x=element_text(angle=45, hjust=1))

#      ggsave(paste(NAME, "figure15.samples.combined.MONOCLE3",  "FIT.MODELS", "PLOT.display.VIOLIN.PLOT.MARKERS", GENE, "png", sep="."), width=30, height=30, units = "cm")

#      plot_genes_in_pseudotime(cds_subset,
#                             color_cells_by="orig.ident",
#                             ncol=2) +
#                             theme(axis.text.x=element_text(angle=45, hjust=1))

#      ggsave(paste(NAME, "figure15.samples.combined.MONOCLE3",  "FIT.MODELS", "PLOT.display.PSEUDOTIME.MARKERS", GENE, "png", sep="."), width=30, height=30, units = "cm")
#    }
# }

########################################################################
######################################################################## in order to save on RAM memory for the next step !!!!!!!!!!!

# rm(gene_fits)
# rm(fit_coefs)
# rm(orig.ident_time_terms)
# rm(sig_genes)

# gc() # to update the OS regarding the objects in use in R

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### GRAPH_TEST
##################################################################################################################################### knn
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
############################################################### we can use NEIGHBOR GRAPH as KNN if we wish or not, more importanly it is to use the PRINCIPAL GRAPH !!!

# knn_test_res <- graph_test(cds,  neighbor_graph="knn", cores=7)

# dim(knn_test_res)
# head(knn_test_res)

# write.table(as.data.frame(knn_deg_ids_order),
#                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure16.the.list.of.DE.genes", "from.MONOCLE3.using.MORAN.INDEX.the.KNN.RESULTS.txt", sep="."),
#                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

# knn_deg_ids <- subset(knn_test_res, q_value < 1e-2)

#> dim(subset(knn_test_res, q_value < 0.05))
#[1] 8243    7
#> dim(subset(knn_test_res, q_value < 0.1e-5))
#[1] 4492    7
#> dim(subset(knn_test_res, q_value < 0.1e-7))
#[1] 3978    7
#> dim(subset(knn_test_res, q_value < 0.1e-8))
#[1] 3763    7
#> dim(subset(knn_test_res, q_value < 0.1e-9))
#[1] 3563    7
#> dim(subset(knn_test_res, q_value < 0.1e-10))

# dim(knn_deg_ids)  
# head(knn_deg_ids)

# knn_deg_ids_genes <- row.names(subset(knn_test_res, q_value < 1e-2))

# write.table(as.data.frame(knn_deg_ids),
#                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure16.the.list.of.DE.genes", "from.MONOCLE3.using.GRAPH_TEST.the.KNN.txt", sep="."),
#                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

# knn_deg_ids_order = knn_deg_ids[order(knn_deg_ids$q_value, -knn_deg_ids$morans_I),]

# write.table(as.data.frame(knn_deg_ids_order),
#                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure16.the.list.of.DE.genes", "from.MONOCLE3.using.MORAN.INDEX.the.KNN.txt", sep="."),
#                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

# knn_deg_ids_order_top10    =  head(knn_deg_ids_order, 10)
# knn_deg_ids_order_bottom10 =  tail(knn_deg_ids_order, 10)

# write.table(as.data.frame(knn_deg_ids_order_top10),
#                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure16.the.list.of.DE.genes", "from.MONOCLE3.using.GRAPH_TEST.the.KNN.z.top10.txt", sep="."),
#                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

# write.table(as.data.frame(knn_deg_ids_order_bottom10),
#                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure16.the.list.of.DE.genes", "from.MONOCLE3.using.GRAPH_TEST.the.KNN.z.bottom10.txt", sep="."),
#                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

############################################################################# now if we want to display the TOP and BOTTOM 10 GENES in PSEUDOTIME
############################################################################# or as VIOLIN PLOTS
############################################################################# or as DOT PLOTS
#############################################################################

# try(plot_genes_by_group(cds,
#                  group_cells_by = "orig.ident",
#                  markers = knn_deg_ids_order_top10$gene ) +
#                  theme(axis.text.x=element_text(angle=45, hjust=1)) )

# try(ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure16.the.list.of.DE.genes", "from.MONOCLE3.using.GRAPH_TEST.the.KNN", "display.DOT.PLOT.MARKERS", "top10", "png", sep="."), width=30, height=30, units = "cm"))

# for (i in 1:length(knn_deg_ids_order_top10$gene))
# {
#    GENE = knn_deg_ids_order_top10$gene[i]

#    if (GENE %in% rowData(cds)$gene)
#    {
#      cds_subset <- cds[rowData(cds)$gene_short_name %in% GENE,]
#
#      plot_genes_violin(cds_subset,
#                 group_cells_by="orig.ident", ncol=2) +
#                 theme(axis.text.x=element_text(angle=45, hjust=1))
#
#      ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure16.the.list.of.DE.genes", "from.MONOCLE3.using.GRAPH_TEST.the.KNN", "display.VIOLIN.PLOT.MARKERS", "top10", GENE, "png", sep="."), width=30, height=30, units = "cm")
#
#      plot_genes_in_pseudotime(cds_subset,
#                             color_cells_by="orig.ident",
#                             ncol=2) +
#                             theme(axis.text.x=element_text(angle=45, hjust=1))
#
#      ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure16.the.list.of.DE.genes", "from.MONOCLE3.using.GRAPH_TEST.the.KNN", "display.PSEUDOTIME.PLOT.MARKERS", "top10", GENE, "png", sep="."), width=30, height=30, units = "cm")
#    }
# }

################################################################################ for bottom GENES

# try( plot_genes_by_group(cds,
#                   group_cells_by = "orig.ident",
#                   markers = knn_deg_ids_order_bottom10$gene ) +
#                   theme(axis.text.x=element_text(angle=45, hjust=1)) )

# try(ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure16.the.list.of.DE.genes", "from.MONOCLE3.using.GRAPH_TEST.the.KNN", "display.DOT.PLOT.MARKERS", "bottom10", "png", sep="."), width=30, height=30, units = "cm") )

# for (i in 1:length(knn_deg_ids_order_bottom10$gene))
# {
#    GENE = knn_deg_ids_order_bottom10$gene[i]
#
#    if (GENE %in% rowData(cds)$gene)
#    {
#      cds_subset <- cds[rowData(cds)$gene_short_name %in% GENE,]
#
#      plot_genes_violin(cds_subset,
#                 group_cells_by="orig.ident", ncol=2) +
#                 theme(axis.text.x=element_text(angle=45, hjust=1))
#      ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure16.the.list.of.DE.genes", "from.MONOCLE3.using.GRAPH_TEST.the.KNN", "display.VIOLIN.PLOT.MARKERS", "bottom10", GENE, "png", sep="."), width=30, height=30, units = "cm")
#
#      plot_genes_in_pseudotime(cds_subset,
#                             color_cells_by="orig.ident",
#                             ncol=2) +
#                             theme(axis.text.x=element_text(angle=45, hjust=1))
#
#      ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure16.the.list.of.DE.genes", "from.MONOCLE3.using.GRAPH_TEST.the.KNN", "display.PSEUDOTIME.PLOT.MARKERS", "bottom10", GENE, "png", sep="."), width=30, height=30, units = "cm")
#    }
#}

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### GRAPH_TEST
##################################################################################################################################### "principal_graph"
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

# pr_test_res <- graph_test(cds, neighbor_graph="principal_graph", cores=7) 

# dim(pr_test_res)
# head(pr_test_res)

#####################################################################################################################################
##################################################################################################################################### printing ALL the genes after applying the function GRAPH_TEST !!!!!!!!!!

# pr_test_res <- graph_test(cds, neighbor_graph="principal_graph", cores=7) 

# write.table(as.data.frame(pr_test_res),
#                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure17.the.list.of.genes", "from.MONOCLE3.using.GRAPH_TEST.principal_graph.RESULTS.txt", sep="."),
#                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

# pr_deg_ids <- subset(pr_test_res, q_value < 1e-2)                   #### We can change the QVALUE !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! although we can select later the genes based on QVALUE and MORAN INDEX
# pr_deg_ids_genes <- row.names(subset(pr_test_res, q_value < 1e-2))  #### We can change the QVALUE !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! although we can select later the genes based on QVALUE and MORAN INDEX

# write.table(as.data.frame(pr_deg_ids),
#                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure17.the.list.of.DE.genes", "from.MONOCLE3.using.GRAPH_TEST.principal_graph.Q_VAL.txt", sep="."),
#                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

# pr_deg_ids_order = pr_deg_ids[order(pr_deg_ids$q_value, -pr_deg_ids$morans_I),]  ### to SORT based on Q-VALUE and based on MORAN-INDEX !!!!!!!!!!!!!!
# pr_deg_ids_order_top10    =  head(pr_deg_ids_order, 50)
# pr_deg_ids_order_bottom10 =  tail(pr_deg_ids_order, 50)

# write.table(as.data.frame(pr_deg_ids_order_top10),
#                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure17.the.list.of.DE.genes", "from.MONOCLE3.using.GRAPH_TEST.principal_graph.z.top50.txt", sep="."),
#                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

# write.table(as.data.frame(pr_deg_ids_order_bottom10),
#                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure17.the.list.of.DE.genes", "from.MONOCLE3.using.GRAPH_TEST.principal_graph.z.bottom50.txt", sep="."),
#                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
############################################################################# if we want to display the TOP and BOTTOM 10 GENES in PSEUDOTIME
############################################################################# or as VIOLIN PLOTS
############################################################################# or as DOT PLOTS
#############################################################################

################################################################################
################################################################################ for TOP GENES
################################################################################

# try( plot_genes_by_group(cds,
#                         group_cells_by = "orig.ident",
#                         markers = pr_deg_ids_order_top10$gene ) +
#                         theme(axis.text.x=element_text(angle=45, hjust=1)) )

# try( ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure17.DP.genes", "MONOCLE3.using.GRAPH_TEST.principal_graph", "DOT.PLOT.MARKERS", "top10", "png", sep="."), width=30, height=30, units = "cm") )


# for (i in 1:length(pr_deg_ids_order_top10$gene))
# {
#    GENE = pr_deg_ids_order_top10$gene[i]
#
#    if (GENE %in% rowData(cds)$gene)
#    {
#      cds_subset <- cds[rowData(cds)$gene_short_name %in% GENE,]#
#
#      plot_genes_violin(cds_subset,
#                       group_cells_by="orig.ident", ncol=2) +
#                       theme(axis.text.x=element_text(angle=45, hjust=1))
#
#      ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure17.DP.genes", "MONOCLE3.using.GRAPH_TEST.principal_graph", "VIOLIN.PLOT.MARKERS", "top10", GENE, "png", sep="."), width=30, height=30, units = "cm")
#
#      plot_genes_in_pseudotime(cds_subset,
#                             color_cells_by="orig.ident",
#                             ncol=2) +
#                             theme(axis.text.x=element_text(angle=45, hjust=1))
#
#      ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure17.DP.genes", "MONOCLE3.using.GRAPH_TEST.principal_graph", "PSEUDOTIME.PLOT.MARKERS", "top10", GENE, "png", sep="."), width=30, height=30, units = "cm")
#    }
# }

################################################################################
################################################################################ for bottom GENES
################################################################################

# try( plot_genes_by_group(cds,
#                    group_cells_by = "orig.ident",
#                    markers = pr_deg_ids_order_bottom10$gene ) +
#                    theme(axis.text.x=element_text(angle=45, hjust=1)) )

# try( ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure17.DP.genes", "MONOCLE3.using.GRAPH_TEST.principal_graph", "DOT.PLOT.MARKERS", "bottom10", "png", sep="."), width=30, height=30, units = "cm") )
# 
# for (i in 1:length(pr_deg_ids_order_bottom10$gene))
# {
#    GENE = pr_deg_ids_order_bottom10$gene[i]
#
#    if (GENE %in% rowData(cds)$gene)
#    {
#      cds_subset <- cds[rowData(cds)$gene_short_name %in% GENE,]
#
#      plot_genes_violin(cds_subset,
#                       group_cells_by="orig.ident", ncol=2) +
#                       theme(axis.text.x=element_text(angle=45, hjust=1))
#
#      ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure17.DP.genes", "MONOCLE3.using.GRAPH_TEST.principal_graph", "VIOLIN.PLOT.MARKERS", "bottom10", GENE, "png", sep="."), width=30, height=30, units = "cm")
#
#      plot_genes_in_pseudotime(cds_subset,
#                             color_cells_by="orig.ident",
#                             ncol=2) +
#                             theme(axis.text.x=element_text(angle=45, hjust=1))
#
#      ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure17.DP.genes", "MONOCLE3.using.GRAPH_TEST.principal_graph", "PSEUDOTIME.PLOT.MARKERS", "bottom10", GENE, "png", sep="."), width=30, height=30, units = "cm")
#    }
# }

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
########################################################################################################################################################## from SUI WANG
##########################################################################################################################################################
########################################################################################################################################################## to display the KNOWN GENES
##########################################################################################################################################################
# source("a_pipeline_scRNAseq_SEURAT3_MONOCLE3_for_SPECIFIC_MARKERS_at_the_END_per_CLUSTER_16oct2020.R")

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
########################################################################################################################################################## ### we need to include "}"
########################################################################################################################################################## ### SHALL we display the TRAJECTORY for each CLUSTER !!!!! as we have set up at the beginning !!!!
# }

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
########################################################################################################################################################## PSEUDOTIME !!!!!!!!!!!!!!!!!
##########################################################################################################################################################
########################################################################################################################################################## in order to show the HEATMAPS of DP genes !!!!

# genes = as.data.frame(pr_deg_ids_genes)[,1] ### selecting the NAMES of the GENES !!!! !!!!!!!!!!!!!!!!!!!!!!!!!!!
# cds@assays@data$counts
# cds@assays@data$counts[match(genes,rowData(cds)[,2]),order(pseudotime(cds))]

# # We can read a favourite LIST of GENES or we can select the TOP GENES based on MORAN INDEX and based on Q-VALUE ### to use this code below !!!!!!!!!!!!!

# genes  <- read.delim("GENES.txt",header=T,sep="\t",stringsAsFactors=F)[,1] ### We can read the genes from a specific TEXT FILE !!!!!!!!!!!!!!!!!!!!!!!!!!

# or we can select 100  TOP GENES that are Differentially Progressing based on Moran index and based on Q-VALUES ... !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################

pr_test_res <- graph_test(cds, neighbor_graph="principal_graph", cores=7) 

write.table(as.data.frame(pr_test_res),
                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure17.the.list.of.genes", "from.MONOCLE3.using.GRAPH_TEST.principal_graph.RESULTS.txt", sep="."),
                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

pr_deg_ids <- subset(pr_test_res, q_value < 1e-2)                   #### We can change the QVALUE !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! although we can select later the genes based on QVALUE and MORAN INDEX
pr_deg_ids_genes <- row.names(subset(pr_test_res, q_value < 1e-2))  #### We can change the QVALUE !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! although we can select later the genes based on QVALUE and MORAN INDEX

write.table(as.data.frame(pr_deg_ids),
                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure17.the.list.of.DE.genes", "from.MONOCLE3.using.GRAPH_TEST.principal_graph.Q_VAL.txt", sep="."),
                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

######################################################################### to prepare for doing the HEATMAP on the TOP DIFFERENTIALLY PROGRESSING GENES 
######################################################################### that have been selected based on MORAN_TEST_STATISTICS > 20 , and Q-VALUE < 1e-150 !!!!!!!!!!!!!

pr_graph_test_res = pr_test_res

hits = as.data.frame(pr_graph_test_res[pr_graph_test_res$gene_short_name,])
hits2.pass = subset(hits, morans_test_statistic > 20 & hits$q_value < 1e-150)

dim(hits2.pass)
hits2.pass = hits2.pass[order(hits2.pass$q_value),]
hits2.passtop = hits2.pass[1:100,]

write.table(as.data.frame(hits2.passtop),
                         file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure18.the list.of.gnes", "MONOCLE3.using.100.SELECTED.GENES.MORAN20.QVALUEsmall.txt", sep="."),
                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

genes2top = hits2.passtop$gene
pt2top.matrix <- as.matrix(cds@assays@data$counts[match(genes2top,rowData(cds)[,2]),order(pseudotime(cds))])
pt2top.matrix <- t(apply(pt2top.matrix,1,function(x){smooth.spline(x,df=3)$y}))
pt2top.matrix <- t(apply(pt2top.matrix,1,function(x){(x-mean(x))/sd(x)}))
rownames(pt2top.matrix) <- genes2top

##########################################################################################################################################################
########################################################################################################################################################## We shall do the HEATMAPS on the LOCAL PC
########################################################################################################################################################## after downloading the FILES with the Z-scores of the PSEUDOTIME. 
##########################################################################################################################################################
##########################################################################################################################################################

write.table(as.data.frame(pt2top.matrix),
                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure18.the.list.of.100.DP.genes", "MONOCLE3.using.GRAPH_TEST.principal_graph.for.HEATMAP.txt", sep="."),
                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

#### if we wann display also the HEATMAP of the TRANSPOSE MATRIX !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

pt2top.matrix.T = t(pt2top.matrix)

write.table(as.data.frame(pt2top.matrix),
                        file=paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure18.the.list.of.100.DP.genes", "MONOCLE3.using.GRAPH_TEST.principal_graph.for.HEATMAP.transposed.txt", sep="."),
                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)


##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
### to save the IMAGE : 

###  although I elieve that we have used : the OLD one : integrated.integration.SEURAT.reciprocalPCA.RData.after.plotly3D
# save.image(file="integrated.integration.SEURAT.reciprocalPCA.RData.after.plotly3D.after.Monocle3.RData")

######################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################

##########################################################################################################################################################
########################################################################################################################################################## we download the files ABOVE on the LOCAL MACHINE where we do the HEATMAPS
##########################################################################################################################################################
##########################################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### the rest of the ANALYSIS we can do on the local PC in order to make the HEATMAPS !!!!!!!!!!!!!!
#####################################################################################################################################
##################################################################################################################################### on the LOCAL MACHINE !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
############# to use this file for the HEATMAP on the LOCAL MACHINE
############# MONOCLE.figs.CLUSTER.3.figure18.the.list.of.100.DP.genes.MONOCLE3.using.GRAPH_TEST.principal_graph.for.HEATMAP.txt

library("ComplexHeatmap")
library("pheatmap")
library("circlize")
library("RColorBrewer")
library("ggplot2")

z = read.delim("MONOCLE.figs.CLUSTER.3.figure18.the.list.of.100.DP.genes.MONOCLE3.using.GRAPH_TEST.principal_graph.for.HEATMAP.txt", header=T, sep="\t", stringsAsFactors = F)
NAME = "Muller_Glia"
NUMBER_CLUSTER = 3

png(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure19.samples.combined.MONOCLE3", "HEATMAP", "PSEUDOTIME.top100", "png", sep="."), width = 800, height = 1200, units = "px",)
Heatmap(
  as.matrix(z),
  name                         = "z-score",
  col                          = colorRamp2(seq(from=-2,to=2,length=11),rev(brewer.pal(11, "Spectral"))),
  show_row_names               = TRUE,
  show_column_names            = FALSE,
  row_names_gp                 = gpar(fontsize = 6),
  km = 6,
  row_title_rot                = 0,
  cluster_rows                 = TRUE,
  cluster_row_slices           = FALSE,
  cluster_columns              = FALSE)
dev.off()

ggsave(paste(NAME, "CLUSTER", NUMBER_CLUSTER, "figure19.samples.combined.MONOCLE3", "HEATMAP", "PSEUDOTIME.top100", "png", sep="."), width=40, height=100, units = "cm")


########## we may also use the PHEATMAP package, although the widthe and the length need to be setup better !!!!!

# pheatmap(as.matrix(z),
#         # color = cols,  
#         # breaks = bks,  
#         cluster_rows = TRUE,
#         cluster_cols = FALSE,
#         # annotation_names_row = FALSE,
#         # annotation_names_col = FALSE,
#         # legend=FALSE,
#         # border_color = "grey60",
#         # border_color = "black",
#         scale="none",
#         show_rownames = FALSE,
#         show_colnames = TRUE,
#         #labels_row=paste0("oo", 1:2),
#         # labels_col=c("154", "C213", "155"),
#         main="HEATMAP",
#         cellwidth = 3,
#         cellheight = 3,
#         fontsize = 8,
#         # height = "20cm", 
#         # width = "10cm", 
#         file="PT2.MATRIX.4.pheatmap.png")

##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
##########################################################################################################################################################
