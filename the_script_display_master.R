##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
# # module load r/4.0
# R
# # the_script_MASTER_SCRIPT_21nov2021.R
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################

set.seed(423)

library(Cairo)
options(bitmapType='cairo')
library(sf)
library(rgl)
library(patchwork)

library(monocle3)
library(plotly)

library(ggplot2)
library(dplyr)
library(edgeR)

library(Seurat)
library(SeuratData)
library(SeuratWrappers)

library(conos)
library(liger)
library(harmony)

library(cowplot)
library(Matrix)
library(gridExtra)

library(stringr)
library(magrittr)
library(dplyr)
library(purrr)

library(future)
library(future.apply)

library(data.table)
# library(vroom)
# library(tidyverse)

library(stringr)
library(magrittr)
library(dplyr)
library(purrr)

plan("multiprocess", workers = 8)
options(future.globals.maxSize = 64000 * 1024^2)

#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################

load("integrated.reciprocalPCA.SEURAT3_RPCA_filter600.RData.after.ScaleData.for.figs.RData.after.ScaleData.with.fig3A.RData")

NAME="FIGURES"

write.table(as.data.frame(samples.combined.list.combined@meta.data),
                        file=paste(NAME, "META.DATA", "in.assay.RNA.at.the.begining.SCRIPT.txt", sep="."),
                        sep="\t", quote=FALSE, col.names = TRUE, row.names = TRUE)

#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### COLORS depending on the number of SAMPLES
#####################################################################################################################################

COLOR_PALETTE = c("red", "orange", "yellow", "lime", "green", "cyan", "blue", "purple", "magenta", "brown")

#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################

samples.combined.list.combined@meta.data$disease = unlist(lapply(strsplit(as.character(samples.combined.list.combined@meta.data$orig.ident), "\\."), '[[', 1))

samples.combined.list.combined@meta.data$phenotype = as.character(map(strsplit(samples.combined.list.combined@meta.data$orig.ident, split = "\\."), 1))

#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### THE FIGURE 1A :

# Visualization using TSNE :
p1 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by = "disease", label = FALSE)
p2 <- DimPlot(samples.combined.list.combined, reduction = "tsne", label = FALSE)
plot_grid(p1, p2)
ggsave(paste("figure1A.newDim.Plot", "assay.INTEGRATED.display.TSNE.v3", "png", sep="."), width = 40, height = 20, units = "cm")

##################################################################################
# Visualization using UMAP :
p1 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by = "disease", label = FALSE)
p2 <- DimPlot(samples.combined.list.combined, reduction = "umap", label = FALSE)
plot_grid(p1, p2)
ggsave(paste("figure1A.newDim.Plot", "assay.INTEGRATED.display.UMAP.v3", "png", sep="."), width = 40, height = 20, units = "cm")

##################################################################################
################################################################################## also on Figure 1A, just to dissociate the plots :::
##################################################################################
##################################################################################
# Visualization using TSNE :
p1 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by = "disease", label = FALSE)
plot_grid(p1)
ggsave(paste("figure1A.newDim.Plot", "assay.INTEGRATED.display.TSNE.v4.part1", "png", sep="."), width = 20, height = 20, units = "cm")

# Visualization using TSNE :
p2 <- DimPlot(samples.combined.list.combined, reduction = "tsne", label = FALSE)
plot_grid(p2)
ggsave(paste("figure1A.newDim.Plot", "assay.INTEGRATED.display.TSNE.v4.part2", "png", sep="."), width = 20, height = 20, units = "cm")

##################################################################################
##################################################################################
# Visualization using UMAP :
p1 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by = "disease", label = FALSE)
plot_grid(p1)
ggsave(paste("figure1A.newDim.Plot", "assay.INTEGRATED.display.UMAP.v4.part1", "png", sep="."), width = 20, height = 20, units = "cm")

# Visualization using UMAP :
p2 <- DimPlot(samples.combined.list.combined, reduction = "umap", label = FALSE)
plot_grid(p2)
ggsave(paste("figure1A.newDim.Plot", "assay.INTEGRATED.display.UMAP.v4.part2", "png", sep="."), width = 20, height = 20, units = "cm")

#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### 
#####################################################################################################################################
#####################################################################################################################################
# Visualization using TSNE :
p1 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by = "disease", label = FALSE)
p2 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by = "seurat_clusters", label = TRUE)
plot_grid(p1, p2)
ggsave(paste("figure1Aa.newDim.Plot", "assay.INTEGRATED.display.TSNE.v5", "png", sep="."), width = 40, height = 20, units = "cm")

##################################################################################
# Visualization using UMAP :
p1 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by = "disease", label = FALSE)
p2 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by = "seurat_clusters", label = TRUE)
plot_grid(p1, p2)
ggsave(paste("figure1Aa.newDim.Plot", "assay.INTEGRATED.display.UMAP.v5", "png", sep="."), width = 40, height = 20, units = "cm")

##################################################################################
################################################################################## also on Figure 1A, just to dissociate the plots :::
##################################################################################
##################################################################################
# Visualization using TSNE :
p1 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by = "disease", label = FALSE)
plot_grid(p1)
ggsave(paste("figure1Aa.newDim.Plot", "assay.INTEGRATED.display.TSNE.v5.part1", "png", sep="."), width = 20, height = 20, units = "cm")

# Visualization using TSNE :
p2 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by = "seurat_clusters", label = TRUE)
plot_grid(p2)
ggsave(paste("figure1Aa.newDim.Plot", "assay.INTEGRATED.display.TSNE.v5.part2", "png", sep="."), width = 20, height = 20, units = "cm")

# Visualization using TSNE :
p3 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by = "orig.ident", label = FALSE)
plot_grid(p3)
ggsave(paste("figure1Aa.newDim.Plot", "assay.INTEGRATED.display.TSNE.v5.part3", "png", sep="."), width = 20, height = 20, units = "cm")

##################################################################################
##################################################################################
# Visualization using UMAP :
p1 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by = "disease", label = FALSE)
plot_grid(p1)
ggsave(paste("figure1Aa.newDim.Plot", "assay.INTEGRATED.display.UMAP.v5.part1", "png", sep="."), width = 20, height = 20, units = "cm")

# Visualization using UMAP :
p2 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by = "seurat_clusters", label = TRUE)
plot_grid(p2)
ggsave(paste("figure1Aa.newDim.Plot", "assay.INTEGRATED.display.UMAP.v5.part2", "png", sep="."), width = 20, height = 20, units = "cm")

# Visualization using UMAP :
p3 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by = "orig.ident", label = FALSE)
plot_grid(p3)
ggsave(paste("figure1Aa.newDim.Plot", "assay.INTEGRATED.display.UMAP.v5.part3", "png", sep="."), width = 20, height = 20, units = "cm")

#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### THE FIGURE 1B : adding the CLUSTER NUMBER :
#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### adding the CLUSTER NUMBER :
#####################################################################################################################################
##################################################################################################################################### THE FIGURE 1B :
# Visualization using TSNE :
# p1 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by = "celltype", label = TRUE, label.size = 3)
# p2 <- DimPlot(samples.combined.list.combined, reduction = "tsne", label = TRUE, label.size = 3)
# plot_grid(p1, p2)
# ggsave(paste("figure1B.Dim.Plot", "assay.INTEGRATED.display.TSNE.v6", "png", sep="."), width = 40, height = 20, units = "cm")

##################################################################################
# Visualization using UMAP :
# p1 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by = "celltype", label = TRUE, label.size = 3)
# p2 <- DimPlot(samples.combined.list.combined, reduction = "umap", label = TRUE, label.size = 3)
# plot_grid(p1, p2)
# ggsave(paste("figure1B.Dim.Plot", "assay.INTEGRATED.display.UMAP.v6", "png", sep="."), width = 40, height = 20, units = "cm")

##################################################################################
################################################################################## also on Figure 1A, just to dissociate the plots :::
##################################################################################
##################################################################################
# Visualization using TSNE :
# p1 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by = "celltype", label = TRUE, label.size = 3)
# plot_grid(p1)
# ggsave(paste("figure1B.Dim.Plot", "assay.INTEGRATED.display.TSNE.v6.part1", "png", sep="."), width = 20, height = 20, units = "cm")

# Visualization using TSNE :
# p2 <- DimPlot(samples.combined.list.combined, reduction = "tsne", label = TRUE, label.size = 3)
# plot_grid(p2)
# ggsave(paste("figure1B.Dim.Plot", "assay.INTEGRATED.display.TSNE.v6.part2", "png", sep="."), width = 20, height = 20, units = "cm")

##################################################################################
##################################################################################
# Visualization using UMAP :
# p1 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by = "celltype", label = TRUE, label.size = 3)
# plot_grid(p1)
# ggsave(paste("figure1B.Dim.Plot", "assay.INTEGRATED.display.UMAP.v6.part1", "png", sep="."), width = 20, height = 20, units = "cm")

# Visualization using UMAP :
# p2 <- DimPlot(samples.combined.list.combined, reduction = "umap", label = TRUE, label.size = 3)
# plot_grid(p2)
# ggsave(paste("figure1B.Dim.Plot", "assay.INTEGRATED.display.UMAP.v6.part2", "png", sep="."), width = 20, height = 20, units = "cm")

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### displaying the cell type specific markers
##################################################################################################################################### CELL TYPE SPECIFIC MARKERS
#####################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
### in order to print the CELL TYPE and to combine with the ANNOTATIONS from SUI
### the LIST of MARKERS shall be already present in the RDATA OBJECT :)

the.meta.data = as.data.frame(samples.combined.list.combined@meta.data)

the.meta.data$CELL_ID = rownames(the.meta.data)

ANNOTATED.CELL.TYPES =  read.delim("a.LIST.MARKERS.RETINA.mouse.12feb2021.txt.associated.CELL.TYPES.12may2021.txt", header=T, sep="\t", stringsAsFactors=F)                   

### and to integrate THESE FILES :

the.meta.data.and.ANNOTATED.CELL.TYPES = merge(the.meta.data,
                                               ANNOTATED.CELL.TYPES,
                                               by.x = "celltype",
                                               by.y = "CLUSTER")    
                         
row.names(the.meta.data.and.ANNOTATED.CELL.TYPES) = the.meta.data.and.ANNOTATED.CELL.TYPES$CELL_ID

samples.combined.list.combined@meta.data = the.meta.data.and.ANNOTATED.CELL.TYPES

head(samples.combined.list.combined@meta.data)
tail(samples.combined.list.combined@meta.data)

table(samples.combined.list.combined@meta.data$CELL.y)
#        AC ASTROCYTES         BP       CONE         MG       Nann        RGC 
#     24096        303      41619       1561       3888        683       1549 
#       ROD         VC 
#     25601        392 

##################################################################################################################################################################
##################################################################################################################################################################
##################################################################################################################################################################
################################################################################ and displaying based on the CELL TYPE :
################################################################################
##################################################################################################################################################################
##################################################################################################################################################################
##################################################################################################################################################################

SET_7_COLORS = c("red", "black", "darkgreen", "yellow", "blue", "grey", "purple", "pink", "darkorange")

# Visualization using TSNE :
p1 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by = "CELL.y", label = TRUE, label.size = 3, cols = SET_7_COLORS)
p2 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by = "disease", label = TRUE, label.size = 3)
plot_grid(p1, p2)
ggsave(paste("figure1Bb.Dim.Plot", "assay.INTEGRATED.display.TSNE.v6", "png", sep="."), width = 40, height = 20, units = "cm")

##################################################################################
# Visualization using UMAP :
p1 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by = "CELL.y", label = TRUE, label.size = 3, cols = SET_7_COLORS)
p2 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by = "disease", label = TRUE, label.size = 3)
plot_grid(p1, p2)
ggsave(paste("figure1Bb.Dim.Plot", "assay.INTEGRATED.display.UMAP.v6", "png", sep="."), width = 40, height = 20, units = "cm")

##################################################################################
################################################################################## also on Figure 1A, just to dissociate the plots :::
##################################################################################
##################################################################################
# Visualization using TSNE :
p1 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by = "CELL.y", label = TRUE, label.size = 3, cols = SET_7_COLORS)
plot_grid(p1)
ggsave(paste("figure1Bb.Dim.Plot", "assay.INTEGRATED.display.TSNE.v6.part1", "png", sep="."), width = 20, height = 20, units = "cm")

# Visualization using TSNE :
p2 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by ="orig.ident", label = TRUE, label.size = 3)
plot_grid(p2)
ggsave(paste("figure1Bb.Dim.Plot", "assay.INTEGRATED.display.TSNE.v6.part2", "png", sep="."), width = 20, height = 20, units = "cm")

##################################################################################
##################################################################################
# Visualization using UMAP :
p1 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by = "CELL.y", label = TRUE, label.size = 3, cols = SET_7_COLORS)
plot_grid(p1)
ggsave(paste("figure1Bb.Dim.Plot", "assay.INTEGRATED.display.UMAP.v6.part1", "png", sep="."), width = 20, height = 20, units = "cm")

# Visualization using UMAP :
p2 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by ="orig.ident", label = TRUE, label.size = 3)
plot_grid(p2)
ggsave(paste("figure1Bb.Dim.Plot", "assay.INTEGRATED.display.UMAP.v6.part2", "png", sep="."), width = 20, height = 20, units = "cm")

##################################################################################
##################################################################################

# Visualization using TSNE :
p1 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by = "CELL.y", label = TRUE, label.size = 3, cols = SET_7_COLORS)
p2 <- DimPlot(samples.combined.list.combined, reduction = "tsne", group.by = "seurat_clusters", label = TRUE, label.size = 3)
plot_grid(p1, p2)
ggsave(paste("figure1Bb.Dim.Plot", "assay.INTEGRATED.display.TSNE.v6.part3", "png", sep="."), width = 40, height = 20, units = "cm")

##################################################################################
# Visualization using UMAP :
p1 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by = "CELL.y", label = TRUE, label.size = 3, cols = SET_7_COLORS)
p2 <- DimPlot(samples.combined.list.combined, reduction = "umap", group.by = "seurat_clusters", label = TRUE, label.size = 3)
plot_grid(p1, p2)
ggsave(paste("figure1Bb.Dim.Plot", "assay.INTEGRATED.display.UMAP.v6.part3", "png", sep="."), width = 40, height = 20, units = "cm")

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##############################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

# LIST.MARKERS.ordered = read.delim("a.LIST.MARKERS.RETINA.mouse.12feb2021.txt.ordered.CELL.TYPES.txt", header=T, sep="\t", stringsAsFactors=F) ### to read the LIST of OREDERED MARKERS, as Sui suggested.

# LIST.MARKERS.ordered.LIST = LIST.MARKERS.ordered$MARKER

# rownames(LIST.MARKERS.ordered) = LIST.MARKERS.ordered$MARKER

########################################################################################################################
########################################################################################################################
################################################################################ DOT PLOT :

# Idents(samples.combined.list.combined) <- "CELL"   ####### to LABEL the CLUSTERS :)

# DotPlot(samples.combined.list.combined, features = LIST.MARKERS.ordered$MARKER)
# ggsave(paste("figure1C.test.DOT.Plot", "by.CELL", "png", sep="."), width = 40, height = 30, units = "cm") 

# DotPlot(samples.combined.list.combined, features = LIST.MARKERS.ordered$MARKER) + RotatedAxis()
# ggsave(paste("figure1C.test.DOT.Plot", "by.CELL.rotate.axis", "png", sep="."), width = 40, height = 30, units = "cm")

########################################
########################################################################################################################
################################################################################ DOT PLOT :

# Idents(samples.combined.list.combined) <- "integrated_snn_res.0.4"   ####### to LABEL the CLUSTERS :)

# DotPlot(samples.combined.list.combined, features = LIST.MARKERS.ordered$MARKER)
# ggsave(paste("figure1C.test.DOT.Plot", "by.CLUSTER.assay.INTEGRATED.v2", "png", sep="."), width = 40, height = 30, units = "cm") 

# DotPlot(samples.combined.list.combined, features = LIST.MARKERS.ordered$MARKER) + RotatedAxis()
# ggsave(paste("figure1C.test.DOT.Plot", "by.CLUSTER.assay.INTEGRATED.v2.rotate.axis", "png", sep="."), width = 30, height = 40, units = "cm")

##########################################################################################################################################
##########################################################################################################################################
################################################################################
################################################################################
################################################################################ for the HEATMAP, to SCALE AGAIN the MATRIX ...
##########################################################################################################################################
############################################################################################### shall we use : samples.combined.list.combined
##############the another way to display the HEATMAPS would be to extract MATRIX for each CLUSTER, and to compute the RAW SUMS

Idents(samples.combined.list.combined) <- "integrated_snn_res.0.4" 

# table(Idents(samples.combined.list.combined))
#    0     1     2     3     4     5     6     7     8     9    10    11    12 
# 25601 18975  4902  3888  3424  3304  2626  1816  1710  1699  1592  1561  1549 
#   13    14    15    16    17    18    19    20    21    22    23    24    25 
# 1400  1290  1239  1207  1167  1072  1048  1047  1026  1014   989   944   928 
#   26    27    28    29    30    31    32    33    34    35    36    37    38 
#  879   836   803   796   785   781   763   690   650   646   621   414   400 
#   39    40    41    42    43    44    45    46    47    48    49    50    51 
#  392   387   385   333   318   303   294   292   251   164   141   140   134 
#   52    53 
#   43    33 

the_CLUSTERS = unique(samples.combined.list.combined@meta.data$seurat_clusters) 
#  [1] 0  1  10 11 12 13 14 15 16 17 18 19 2  20 21 22 23 24 25 26 27 28 29 3  30
# [26] 31 32 33 34 35 36 37 38 39 4  40 41 42 43 44 45 46 47 48 49 5  50 51 52 53
# [51] 6  7  8  9 

length(the_CLUSTERS)
# [1] 54

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

Idents(samples.combined.list.combined) <- "seurat_clusters" 
levels(samples.combined.list.combined)

cluster.averages.CLUSTER.SEURAT <- AverageExpression(samples.combined.list.combined, slot = "data", group.by = "seurat_clusters" , return.seurat = TRUE) ### CLUSTER AVERAGES is made as a SEURAT OBJECT
                                                                                            

write.table(as.data.frame(cluster.averages.CLUSTER.SEURAT@assays$RNA@counts), file="samples.combined.list.combined.cluster.averages.CLUSTER.SEURAT.return.object.txt", sep="\t",
                                                                              quote=F, col.names=T, row.names=T) 

# cluster.averages.CLUSTER <- AverageExpression(samples.combined.list.combined, slot = "data", group.by = "seurat_clusters" , return.seurat = FALSE)
# head(cluster.averages.CLUSTER$RNA)

# write.table(as.data.frame(cluster.averages.CLUSTER$RNA), 
#           file="samples.combined.list.combined.cluster.averages.CLUSTER.txt", sep="\t",
#           quote=F, col.names=T, row.names=T) 

################################################################################################################################
################################################################################################################################
################################################################################################################################
################################################################################################################################ row.names(cluster.averages.CLUSTER.SEURAT@meta.data)

cluster.averages.CLUSTER.SEURAT@meta.data$CLUSTER = row.names(cluster.averages.CLUSTER.SEURAT@meta.data)

DoHeatmap(cluster.averages.CLUSTER.SEURAT, 
          features = LIST.MARKERS.ordered$MARKER, 
          # group.by = cluster.averages.CLUSTER.SEURAT@meta.data$CLUSTER,
          group.by = "CLUSTER", 
          slot = "scale.data", 
          size = 4.5,
          hjust = 0,
          angle = 90,
          label = TRUE , draw.lines = FALSE) + 
          scale_fill_gradientn(colors = rev(RColorBrewer::brewer.pal(n =4, name = "RdBu")))

ggsave(paste("figure1C.test.HEATMAP", "by.CLUSTER.AVERAGE.CLUSTER.SEURAT.with.Seurat.DoHeatMap.v3", "png", sep="."), width = 40, height = 20, units = "cm")

################################################################################################################################
################################################################################################################################ 
################################################################################################################################
################################################################################################################################ how to group the DATA based on CLUSTERS

my_levels = as.numeric(cluster.averages.CLUSTER.SEURAT@meta.data$CLUSTER)

levels(cluster.averages.CLUSTER.SEURAT) = my_levels

DoHeatmap(cluster.averages.CLUSTER.SEURAT, 
          features = LIST.MARKERS.ordered$MARKER, 
          # group.by = cluster.averages.CLUSTER.SEURAT@meta.data$CLUSTER,
          group.by = "CELL.y", 
          slot = "scale.data", 
          size = 4.5,
          hjust = 0,
          angle = 90,
          label = TRUE , draw.lines = FALSE) + 
          scale_fill_gradientn(colors = rev(RColorBrewer::brewer.pal(n =4, name = "RdBu")))

ggsave(paste("figure1C.test.HEATMAP", "by.CLUSTER.AVERAGE.CLUSTER.SEURAT.with.Seurat.DoHeatMap.v4", "png", sep="."), width = 40, height = 20, units = "cm")

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

CLUSTER.AVERAGED.as.DF = as.data.frame(cluster.averages.CLUSTER.SEURAT@assays$RNA@counts)
dim( CLUSTER.AVERAGED.as.DF) # [1] 25399

######################################################################################################################
######################################################################################################################
######################################################################################################################

CLUSTER.AVERAGED.as.DF$gene = rownames(CLUSTER.AVERAGED.as.DF)

CLUSTER.AVERAGED.as.DF.SUBSET = CLUSTER.AVERAGED.as.DF[CLUSTER.AVERAGED.as.DF$gene %in% LIST.MARKERS.ordered$MARKER, ]

CLUSTER.AVERAGED.as.DF.SUBSET2 = subset(CLUSTER.AVERAGED.as.DF.SUBSET, select = -c(gene))

write.table(CLUSTER.AVERAGED.as.DF.SUBSET2, file = "CLUSTER.AVERAGED.as.DF.SUBSET2.MATRIX.with.KNOWN.MARKERS.txt",
            quote = FALSE, sep = "\t", row.names = TRUE, col.names = TRUE)  

######################################################################################################################
###################################################################################################################### as.matrix(cluster.averages@assays$RNA@data) 
######################################################################################################################

CLUSTER.AVERAGED.as.DF.SUBSET2 = as.matrix(CLUSTER.AVERAGED.as.DF.SUBSET2)

######################################################################################################################
################################################################################ in order to start setting up the HEATMAPS
################################################################################ to display in a new version the CONSERVED MARKERS
######################################################################################################################

# source("the_script_display_FIGURES_making_HEATMAPS_for_KNOWN_MARKERS.R")

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

library(gplots)
library(pheatmap)
library(RColorBrewer)

col <- colorRampPalette(c("blue", "red"))(100)

# pheatmap(mat, color = colorRampPalette(rev(brewer.pal(n = 10, name ="RdYlBu")))(100))
# pheatmap(mat, color = colorRampPalette(brewer.pal(n = 10, name ="RdBu"))(100))

png(paste("figure1C.test.HEATMAP", "by.CLUSTER.AVERAGE", "KNOWN.MARKERS", "with.pheatmap.v2", "png", sep="."),     
                           width = 3200,                      # 5 x 300 pixels
                           height = 1600, 
                           res = 300,                         # 300 pixels per inch
                           pointsize = 8)  

pheatmap(CLUSTER.AVERAGED.as.DF.SUBSET2, 
         color = colorRampPalette(brewer.pal(n = 10, name ="RdYlBu"))(100), 
         kmeans_k = NA, 
         breaks = NA, 
         border_color = "grey60",
         cellwidth = 11, 
         cellheight = 11, 

         scale = "row",
         angle_col = c("270", "0", "45", "90", "315"), 

         cluster_rows = TRUE,
         cluster_cols = TRUE,
         
         show_rownames = T,
         show_colnames = T, 

         main = "", 
         fontsize = 10,

         # clustering_distance_cols = "euclidean",
         # clustering_distance_rows = "euclidean",
         # clustering_method = "complete",

         clustering_distance_rows = "manhattan",
         clustering_method = "centroid",
)
dev.off()

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#########################################################################################################################################################################################################################################################################

library(gplots)
library(pheatmap)
library(RColorBrewer)

col <- colorRampPalette(c("blue", "red"))(100)

# pheatmap(mat, color = colorRampPalette(rev(brewer.pal(n = 10, name ="RdYlBu")))(100))
# pheatmap(mat, color = colorRampPalette(brewer.pal(n = 10, name ="RdBu"))(100))

png(paste("figure1C.HEATMAP", "by.CLUSTER.AVERAGE", "KNOWN.MARKERS", "with.pheatmap.v2.UNCLUSTERED", "png", sep="."),     
                           width = 3200,                      # 5 x 300 pixels
                           height = 1600, 
                           res = 300,                         # 300 pixels per inch
                           pointsize = 8)  

pheatmap(CLUSTER.AVERAGED.as.DF.SUBSET2, 
         color = colorRampPalette(brewer.pal(n = 10, name ="RdYlBu"))(100), 
         kmeans_k = NA, 
         breaks = NA, 
         border_color = "grey60",
         cellwidth = 11, 
         cellheight = 11, 

         scale = "row",
         angle_col = c("270", "0", "45", "90", "315"), 

         cluster_rows = FALSE,
         cluster_cols = FALSE,
         
         show_rownames = T,
         show_colnames = T, 

         main = "", 
         fontsize = 10,

         # clustering_distance_cols = "euclidean",
         # clustering_distance_rows = "euclidean",
         # clustering_method = "complete",

         clustering_distance_rows = "manhattan",
         clustering_method = "centroid",
)
dev.off()


##########################################################################################################################################################################################################################################################################
##################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

# AverageExpression(
#       object,
#       assays = NULL,
#       features = NULL,
#       return.seurat = FALSE,
#       group.by = "ident",
#       add.ident = NULL,
#       slot = "data",
#       verbose = TRUE,
#       ...
#     )


##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
Idents(samples.combined.list.combined) <- "integrated_snn_res.0.4"
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##################################################################################
##################################################################################
################################################################################## label = TRUE, label.size = 3, 
################################################################################## also on Figure 1A, just to dissociate the plots :::
##################################################################################
##################################################################################
##################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
### the CODE for the FIGURE 1D
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

z1 <- TSNEPlot(samples.combined.list.combined)
plot_grid(z1)
ggsave(paste("figure1D.TSNE.Plot", "assay.INTEGRATED.display.plot.TSNEplot", "png", sep="."), width = 20, height = 20, units = "cm")

z2 <- UMAPPlot(samples.combined.list.combined)
plot_grid(z2)
ggsave(paste("figure1D.UMAP.Plot", "assay.INTEGRATED.display.plot.UMAPplot", "png", sep="."), width = 20, height = 20, units = "cm")

z3 <- PCAPlot(samples.combined.list.combined)
plot_grid(z3)
ggsave(paste("figure1D.PCA.Plot", "assay.INTEGRATED.display.plot.PCAplot", "png", sep="."), width = 20, height = 20, units = "cm")

unique(samples.combined.list.combined@meta.data$orig.ident)

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

Idents(samples.combined.list.combined) <- "integrated_snn_res.0.4"
source("the_script_display_FIGURES_fig1D.R")

# source("the_script_display_FIGURES_for_the_ARTICLE_with_SUI_26april2021_to_RETEST6_v2_display_fig1D_in_way1.R")
# source("the_script_display_FIGURES_for_the_ARTICLE_with_SUI_26april2021_to_RETEST6_v2_display_fig1D_in_way2.R")
### perhaps to keep only the DISPLAY in way # 3

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

Idents(samples.combined.list.combined) <- "integrated_snn_res.0.4"
Idents(samples.combined.list.combined) <- "seurat_clusters"

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

source("the_script_display_FIGURES_fig2A.R")

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################


##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
################################################################################## the figure 2C
####################################################################################################################
####################################################################################################################
####################################################################################################################

cluster.averages.CLUSTER.SEURAT.per.STIM <- AverageExpression(samples.combined.list.combined, slot = "data", group.by = c("seurat_clusters", "orig.ident"), return.seurat = TRUE) ### CLUSTER AVERAGES is made as a SEURAT OBJECT
                                                                                            ### and if we need to access it, we do :
head(cluster.averages.CLUSTER.SEURAT.per.STIM@assays$RNA@counts)
unique(colnames(as.data.frame(cluster.averages.CLUSTER.SEURAT.per.STIM@assays$RNA@counts)))

# for examples : "50_STZ.1M" "50_STZ.2M" "50_STZ.3M" "50_STZ.4M"
# [505] "50_STZ.5M" "50_WT.1M"  "50_WT.2M"  "50_WT.3M"  "50_WT.4M"  "50_WT.5M"
#####################################################################################################################

write.table(as.data.frame(cluster.averages.CLUSTER.SEURAT.per.STIM@assays$RNA@counts), 
           file="samples.combined.list.combined.cluster.averages.CLUSTER.SEURAT.per.STIM.return.object.txt", sep="\t",
           quote=F, col.names=T, row.names=T) 

# row.names((cluster.averages.CLUSTER.SEURAT.per.STIM@meta.data))
# [1] "0"  "1"  "2"  "3"  "4"  "5"  "6"  "7"  "8"  "9"  "10" "11" "12" "13" "14"
# [16] "15" "16" "17" "18" "19" "20" "21" "22" "23" "24" "25" "26" "27" "28" "29"
# [31] "30" "31" "32" "33" "34" "35" "36" "37" "38" "39" "40" "41" "42" "43" "44"
# [46] "45" "46" "47" "48" "49" "50" "51" "52" "53"

cluster.averages.CLUSTER.per.STIM <- AverageExpression(samples.combined.list.combined, slot = "data", group.by = c("seurat_clusters", "orig.ident"), return.seurat = FALSE)

write.table(as.data.frame(cluster.averages.CLUSTER.per.STIM$RNA), file="samples.combined.list.combined.cluster.averages.CLUSTER.per.STIM.txt", sep="\t", quote=F, col.names=T, row.names=T) 

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##################################################################################
### now to extract the names of the COLUMNS that we are interested in for the CLUSTERS : 0, 3,  8, 11, 12, 15, 17, 28, 30, 44
### the pattern would be : 0_ ; 3_ ; 8_ ; etc

# cluster.averages.CLUSTER.per.STIM.df = as.data.frame(cluster.averages.CLUSTER.per.STIM$RNA)

#####################################################################################################################################################

# cluster.averages.CLUSTER.per.STIM.df.0 = cluster.averages.CLUSTER.per.STIM.df[, grep(pattern="^0_", colnames(cluster.averages.CLUSTER.per.STIM.df))]

# cluster.averages.CLUSTER.per.STIM.df.3 = cluster.averages.CLUSTER.per.STIM.df[, grep(pattern="^3_", colnames(cluster.averages.CLUSTER.per.STIM.df))]

# cluster.averages.CLUSTER.per.STIM.df.8 = cluster.averages.CLUSTER.per.STIM.df[, grep(pattern="^8_", colnames(cluster.averages.CLUSTER.per.STIM.df))]

# cluster.averages.CLUSTER.per.STIM.df.11 = cluster.averages.CLUSTER.per.STIM.df[, grep(pattern="^11_", colnames(cluster.averages.CLUSTER.per.STIM.df))]

# cluster.averages.CLUSTER.per.STIM.df.12 = cluster.averages.CLUSTER.per.STIM.df[, grep(pattern="^12_", colnames(cluster.averages.CLUSTER.per.STIM.df))]

# cluster.averages.CLUSTER.per.STIM.df.15 = cluster.averages.CLUSTER.per.STIM.df[, grep(pattern="^15_", colnames(cluster.averages.CLUSTER.per.STIM.df))]

# cluster.averages.CLUSTER.per.STIM.df.17 = cluster.averages.CLUSTER.per.STIM.df[, grep(pattern="^17_", colnames(cluster.averages.CLUSTER.per.STIM.df))]

# cluster.averages.CLUSTER.per.STIM.df.28 =  cluster.averages.CLUSTER.per.STIM.df[, grep(pattern="^28_", colnames(cluster.averages.CLUSTER.per.STIM.df))]

# cluster.averages.CLUSTER.per.STIM.df.30 = cluster.averages.CLUSTER.per.STIM.df[, grep(pattern="^30_", colnames(cluster.averages.CLUSTER.per.STIM.df))]

# cluster.averages.CLUSTER.per.STIM.df.44 = cluster.averages.CLUSTER.per.STIM.df[, grep(pattern="^44_", colnames(cluster.averages.CLUSTER.per.STIM.df))]

# colnames(cluster.averages.CLUSTER.per.STIM.df.0)
# colnames(cluster.averages.CLUSTER.per.STIM.df.3)    
# colnames(cluster.averages.CLUSTER.per.STIM.df.8)  
# colnames(cluster.averages.CLUSTER.per.STIM.df.11)  
# colnames(cluster.averages.CLUSTER.per.STIM.df.12)  
# colnames(cluster.averages.CLUSTER.per.STIM.df.15)   
# colnames(cluster.averages.CLUSTER.per.STIM.df.17)  
# colnames(cluster.averages.CLUSTER.per.STIM.df.28)  
# colnames(cluster.averages.CLUSTER.per.STIM.df.30)   
# colnames(cluster.averages.CLUSTER.per.STIM.df.44)

# dim(cluster.averages.CLUSTER.per.STIM.df.0)
# dim(cluster.averages.CLUSTER.per.STIM.df.3)    
# dim(cluster.averages.CLUSTER.per.STIM.df.8)  
# dim(cluster.averages.CLUSTER.per.STIM.df.11)  
# dim(cluster.averages.CLUSTER.per.STIM.df.12)  
# dim(cluster.averages.CLUSTER.per.STIM.df.15)   
# dim(cluster.averages.CLUSTER.per.STIM.df.17)  
# dim(cluster.averages.CLUSTER.per.STIM.df.28)  
# dim(cluster.averages.CLUSTER.per.STIM.df.30)   
# dim(cluster.averages.CLUSTER.per.STIM.df.44)  

#####################################################################################################################################################
################################################################################## and now to print these DF in order to do the heatmaps offline  

# write.table(cluster.averages.CLUSTER.per.STIM.df.0, 
#           file="samples.combined.list.combined.cluster.averages.CLUSTER.SEURAT.per.STIM.cluster.averages.CLUSTER.per.STIM.df.0.txt", sep="\t",
#           quote=F, col.names=T, row.names=T) 

# write.table(cluster.averages.CLUSTER.per.STIM.df.3, 
#           file="samples.combined.list.combined.cluster.averages.CLUSTER.SEURAT.per.STIM.cluster.averages.CLUSTER.per.STIM.df.3.txt", sep="\t",
#           quote=F, col.names=T, row.names=T) 

# write.table(cluster.averages.CLUSTER.per.STIM.df.8, 
#           file="samples.combined.list.combined.cluster.averages.CLUSTER.SEURAT.per.STIM.cluster.averages.CLUSTER.per.STIM.df.8.txt", sep="\t",
#           quote=F, col.names=T, row.names=T) 

# write.table(cluster.averages.CLUSTER.per.STIM.df.11, 
#            file="samples.combined.list.combined.cluster.averages.CLUSTER.SEURAT.per.STIM.cluster.averages.CLUSTER.per.STIM.df.11.txt", sep="\t",
#            quote=F, col.names=T, row.names=T) 

# write.table(cluster.averages.CLUSTER.per.STIM.df.12, 
#           file="samples.combined.list.combined.cluster.averages.CLUSTER.SEURAT.per.STIM.cluster.averages.CLUSTER.per.STIM.df.12.txt", sep="\t",
#           quote=F, col.names=T, row.names=T) 

# write.table(cluster.averages.CLUSTER.per.STIM.df.15, 
#           file="samples.combined.list.combined.cluster.averages.CLUSTER.SEURAT.per.STIM.cluster.averages.CLUSTER.per.STIM.df.15.txt", sep="\t",
#           quote=F, col.names=T, row.names=T) 

# write.table(cluster.averages.CLUSTER.per.STIM.df.17, 
#           file="samples.combined.list.combined.cluster.averages.CLUSTER.SEURAT.per.STIM.cluster.averages.CLUSTER.per.STIM.df.17.txt", sep="\t",
#           quote=F, col.names=T, row.names=T) 

# write.table(cluster.averages.CLUSTER.per.STIM.df.28, 
#           file="samples.combined.list.combined.cluster.averages.CLUSTER.SEURAT.per.STIM.cluster.averages.CLUSTER.per.STIM.df.28.txt", sep="\t",
#           quote=F, col.names=T, row.names=T) 

# write.table(cluster.averages.CLUSTER.per.STIM.df.30, 
#           file="samples.combined.list.combined.cluster.averages.CLUSTER.SEURAT.per.STIM.cluster.averages.CLUSTER.per.STIM.df.30.txt", sep="\t",
#           quote=F, col.names=T, row.names=T) 

# write.table(cluster.averages.CLUSTER.per.STIM.df.44, 
#           file="samples.combined.list.combined.cluster.averages.CLUSTER.SEURAT.per.STIM.cluster.averages.CLUSTER.per.STIM.df.44.txt", sep="\t",
#           quote=F, col.names=T, row.names=T) 


##################################################################################################################################################### FIGURE 3A
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

# Violin plot of the following genes in all 20 samples.

# Gfap, Zfp36, cebpd, timp1, crym, lcn2, cp, txnip, fth1, press56, id3, id4, id2, clvs1, agt, agmo, gadd45g, gnb3, mlf1, ptprn2, Zmat4, Tmsb4x, Nrxn3, ccdc136, opn1sw, Eno1,
# B2m, LOC100364435, Ifi27l2b, vgf, car3, hspb1, chi3l1, dkk3, Rlbp1.

LIST_GENES_SUI = list("Gfap", "Zfp36", "Cebpd", "Timp1", "Crym", "Lcn2", "Cp", "Txnip", "Fth1", "Prss56", "Id3", "Id4", "Id2", 
                      "Clvs1", "Agt", "Agmo", "Gadd45g", "Gnb3", "Mlf1", "Ptprn2", "Zmat4", "Tmsb4x", "Nrxn3", "Ccdc136", "Opn1sw", 
                      "Eno1", "B2m",  "LOC100364435", "Ifi27l2b", "Vgf", "Car3", "Hspb1", "Chi3l1", "Dkk3", "Rlbp1")

### and to DISPLAY these GENES in the CLUSTERS : 0, 3, 11, 17, 44

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

Idents(samples.combined.list.combined) <- "orig.ident" 

# cluster0
# cluster3
# cluster11
# cluster17
# cluster44

# in order to double check the META.DATA :
head(cluster0@meta.data)
head(cluster3@meta.data)
head(cluster11@meta.data)
head(cluster17@meta.data)
head(cluster44@meta.data)

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##################################################################################
################################################################################## the figure 3A : we have a new organization of the VIOLIN PLOTS
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

LIST_GENES_SUI = list("Gfap", "Zfp36", "Cebpd", "Timp1", "Crym", "Lcn2", "Cp", "Txnip", "Fth1", "Prss56", "Id3", "Id4", "Id2", 
                     "Clvs1", "Agt", "Agmo", "Gadd45g", "Gnb3", "Mlf1", "Ptprn2", "Zmat4", "Tmsb4x", "Nrxn3", "Ccdc136", "Opn1sw", 
                      "Eno1", "B2m",  "LOC100364435", "Ifi27l2b", "Vgf", "Car3", "Hspb1", "Chi3l1", "Dkk3", "Rlbp1")

# cluster0
# cluster3
# cluster11
# cluster17
# cluster44

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

Idents(cluster0) <- "orig.ident" 

for (i in 1:length(LIST_GENES_SUI)) { 
    VlnPlot(cluster0, features = LIST_GENES_SUI[[i]] )
    ggsave(paste("figure3A.VIOLIN.Plot", "CLUSTER.0", "gene", LIST_GENES_SUI[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
    RidgePlot(cluster0, features = LIST_GENES_SUI[[i]] )
    ggsave(paste("figure3A.RIDGE.Plot", "CLUSTER.0", "gene", LIST_GENES_SUI[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
}

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

Idents(cluster3) <- "orig.ident" 

for (i in 1:length(LIST_GENES_SUI)) { 
    VlnPlot(cluster3, features = LIST_GENES_SUI[[i]] )
    ggsave(paste("figure3A.VIOLIN.Plot", "CLUSTER.3", "gene", LIST_GENES_SUI[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
    RidgePlot(cluster3, features = LIST_GENES_SUI[[i]] )
    ggsave(paste("figure3A.RIDGE.Plot", "CLUSTER.3", "gene", LIST_GENES_SUI[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
}

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

Idents(cluster11) <- "orig.ident" 

for (i in 1:length(LIST_GENES_SUI)) { 
    VlnPlot(cluster11, features = LIST_GENES_SUI[[i]] )
    ggsave(paste("figure3A.VIOLIN.Plot", "CLUSTER.11", "gene", LIST_GENES_SUI[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
    RidgePlot(cluster11, features = LIST_GENES_SUI[[i]] )
    ggsave(paste("figure3A.RIDGE.Plot", "CLUSTER.11", "gene", LIST_GENES_SUI[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
}

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

Idents(cluster17) <- "orig.ident" 

for (i in 1:length(LIST_GENES_SUI)) { 
    VlnPlot(cluster17, features = LIST_GENES_SUI[[i]] )
    ggsave(paste("figure3A.VIOLIN.Plot", "CLUSTER.17", "gene", LIST_GENES_SUI[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
    RidgePlot(cluster17, features = LIST_GENES_SUI[[i]] )
    ggsave(paste("figure3A.RIDGE.Plot", "CLUSTER.17", "gene", LIST_GENES_SUI[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
}

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

Idents(cluster44) <- "orig.ident" 

for (i in 1:length(LIST_GENES_SUI)) { 
    VlnPlot(cluster44, features = LIST_GENES_SUI[[i]] )
    ggsave(paste("figure3A.VIOLIN.Plot", "CLUSTER.44", "gene", LIST_GENES_SUI[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
    RidgePlot(cluster44, features = LIST_GENES_SUI[[i]] )
    ggsave(paste("figure3A.RIDGE.Plot", "CLUSTER.44", "gene", LIST_GENES_SUI[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
}

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

# unique(samples.combined.list.combined@meta.data$seurat_clusters) 

# Idents(samples.combined.list.combined) = "orig.ident"
# GENE = "Ddit4" 
# Idents(cluster0) <- "orig.ident" 

# for (j in 1:length(unique(samples.combined.list.combined@meta.data$seurat_clusters))) 
#{
#     # CLUSTER = as.factor(j-1) 
#     #  print(CLUSTER) } 
#     # CLUSTER = unique(samples.combined.list.combined@meta.data$seurat_clusters)[j-1]
#     CLUSTER = subset(x = samples.combined.list.combined, subset = (seurat_clusters == j-1))    
#
#
#   for (i in 1:length(GENE)) { 
#       VlnPlot(CLUSTER, features = GENE[[i]])
#       ggsave(paste("figure.z.DDIT4.VIOLIN.Plot", "CLUSTER", j-1 , "gene", GENE[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
#       RidgePlot(CLUSTER, features = GENE[[i]])
#       ggsave(paste("figure.z.DDIT4.RIDGE.Plot", "CLUSTER", j-1 , "gene",  GENE[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
#       FeaturePlot(CLUSTER, features = GENE[[i]])
#       ggsave(paste("figure.z.DDIT4.FEATURE.Plot", "CLUSTER", j-1 , "gene",  GENE[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
#       DotPlot(CLUSTER, features = GENE[[i]])
#       ggsave(paste("figure.z.DDIT4.DOT.Plot", "CLUSTER", j-1 , "gene",  GENE[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
#
#   }
# }

# VlnPlot(samples.combined.list.combined, features = GENE[[i]])
# ggsave(paste("figure.z.DDIT4.VIOLIN.Plot", "CLUSTER.ALL", "gene", GENE[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")

# RidgePlot(samples.combined.list.combined, features = GENE[[i]])
# ggsave(paste("figure.z.DDIT4.RIDGE.Plot", "CLUSTER.ALL", "gene",  GENE[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")

# FeaturePlot(samples.combined.list.combined, features = GENE[[i]])
# ggsave(paste("figure.z.DDIT4.FEATURE.Plot", "CLUSTER.ALL", "gene",  GENE[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")

# DotPlot(samples.combined.list.combined, features = GENE[[i]])
# ggsave(paste("figure.z.DDIT4.DOT.Plot", "CLUSTER.ALL" , "gene",  GENE[[i]], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################

# LIST.KNOWN.MARKERS = read.delim("a.LIST.MARKERS.RETINA.mouse.RNAseq.txt", header=T, sep="\t", stringsAsFactors=F)

# dim(LIST.KNOWN.MARKERS)
# head(LIST.KNOWN.MARKERS)

# for (j in 1:length(unique(samples.combined.list.combined@meta.data$seurat_clusters))) 
# {
#     # CLUSTER = as.factor(j-1) 
#     #  print(CLUSTER) } 
#     # CLUSTER = unique(samples.combined.list.combined@meta.data$seurat_clusters)[j-1]
#     CLUSTER = subset(x = samples.combined.list.combined, subset = (seurat_clusters == j-1))    
#
#     for (i in 1:dim(LIST.KNOWN.MARKERS)[1]){
#            if (LIST.KNOWN.MARKERS$MARKER[i] %in% row.names(samples.combined.list.combined[["RNA"]]@data)) {
#
#              VlnPlot(CLUSTER, features = LIST.KNOWN.MARKERS$MARKER[i] )
#              ggsave(paste("figure.zz.RNAseq.VIOLIN.Plot", "CLUSTER", j-1 , "gene", LIST.KNOWN.MARKERS$MARKER[i], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
#              RidgePlot(CLUSTER, features = LIST.KNOWN.MARKERS$MARKER[i] )
#              ggsave(paste("figure.zz.RNAseq.RIDGE.Plot", "CLUSTER", j-1 , "gene",  LIST.KNOWN.MARKERS$MARKER[i], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
#              FeaturePlot(CLUSTER, features = LIST.KNOWN.MARKERS$MARKER[i] )
#              ggsave(paste("figure.zz.RNAseq.FEATURE.Plot", "CLUSTER", j-1 , "gene", LIST.KNOWN.MARKERS$MARKER[i], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
#              DotPlot(CLUSTER, features = LIST.KNOWN.MARKERS$MARKER[i] )
#              ggsave(paste("figure.zz.RNAseq.DOT.Plot", "CLUSTER", j-1 , "gene",  LIST.KNOWN.MARKERS$MARKER[i], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
#
#      }
#   }
# }

# }


# for (i in 1:dim(LIST.KNOWN.MARKERS)[1]){
#    if (LIST.KNOWN.MARKERS$MARKER[i] %in% row.names(samples.combined.list.combined[["RNA"]]@data)) {
#
#       VlnPlot(samples.combined.list.combined, features = LIST.KNOWN.MARKERS$MARKER[i] )
#       ggsave(paste("figure.zz.RNAseq.VIOLIN.Plot", "CLUSTER.ALL", "gene", LIST.KNOWN.MARKERS$MARKER[i], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
#
#       RidgePlot(samples.combined.list.combined, features = LIST.KNOWN.MARKERS$MARKER[i] )
#       ggsave(paste("figure.zz.RNAseq.RIDGE.Plot", "CLUSTER.ALL", "gene", LIST.KNOWN.MARKERS$MARKER[i], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
#
#       FeaturePlot(samples.combined.list.combined, features = LIST.KNOWN.MARKERS$MARKER[i] )
#       ggsave(paste("figure.zz.RNAseq.FEATURE.Plot", "CLUSTER.ALL", "gene", LIST.KNOWN.MARKERS$MARKER[i], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
#
#       DotPlot(samples.combined.list.combined, features = LIST.KNOWN.MARKERS$MARKER[i] )
#       ggsave(paste("figure.zz.RNAseq.DOT.Plot", "CLUSTER.ALL" , "gene", LIST.KNOWN.MARKERS$MARKER[i], "by.SAMPLE.png", sep="."), width = 20, height = 20, units = "cm")
#        
#    }
# }

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### some previous code that we did have before making the object !!!

# setwd("./scRNAseq/batch_correction_SEURAT3_RPCA_filter600_a_COPY_file_RDATA/")
# list.files()

##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
##########################################################################################################################################################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
### to rerun UMAP on 3 COMPONENTS : n.components = 3L 
### samples.combined.list.combined <- RunTSNE(samples.combined.list.combined, reduction = "pca", dims = 1:30, n.components = 3L)
### samples.combined.list.combined <- RunUMAP(samples.combined.list.combined, reduction = "pca", dims = 1:30, n.components = 3L)
#####################################################################################################################################
#####################################################################################################################################
#####################################################################################################################################
##################################################################################################################################### 3D visualization
#####################################################################################################################################
#####################################################################################################################################

# umap_1 <- samples.combined.list.combined[["umap"]]@cell.embeddings[,1]
# umap_2 <- samples.combined.list.combined[["umap"]]@cell.embeddings[,2]
# umap_3 <- samples.combined.list.combined[["umap"]]@cell.embeddings[,3]

# Embeddings(object = samples.combined.list.combined, reduction = "umap")

################################################################################################################
################################################################################################################

# plot.data <- FetchData(object = samples.combined.list.combined, vars = c("UMAP_1", "UMAP_2", "UMAP_3", "seurat_clusters"))

# plot.data$label <- paste(rownames(plot.data))

# plot.data$label

# p = plot_ly(data = plot.data,
#        x = ~UMAP_1,
#        y = ~UMAP_2,
#        z = ~UMAP_3,
#        color = ~seurat_clusters,
#        type = "scatter3d",
#        mode = "markers",
#        marker = list(size = 5, width=2), # controls size of points
#        text = ~label,      # This is that extra column we made earlier for which we will use for cell ID
#        hoverinfo = "text") # When you visualize your plotly object, hovering your mouse pointer over a point shows cell names

# p %>% layout()

# htmlwidgets::saveWidget(p, paste(NAME, "htmlwidgetsindex.Seurat.Clusters.html", sep="."))

################################################################################################################
################################################################################################################ to change the LABELLING 

# plot.data <- FetchData(object = samples.combined.list.combined, vars = c("UMAP_1", "UMAP_2", "UMAP_3", "seurat_clusters"))

# plot.data$label <- paste(rownames(plot.data))

# plot.data$label <- plot.data$seurat_clusters
# plot.data$label

# p = plot_ly(data = plot.data,
#        x = ~UMAP_1,
#        y = ~UMAP_2,
#        z = ~UMAP_3,
#        color = ~seurat_clusters,
#        type = "scatter3d",
#        mode = "markers",
#        marker = list(size = 5, width=2), # controls size of points
#        text = ~label,      # This is that extra column we made earlier for which we will use for cell ID
#        hoverinfo = "text") # When you visualize your plotly object, hovering your mouse pointer over a point shows cell names

# p %>% layout()

# htmlwidgets::saveWidget(p, paste(NAME, "htmlwidgetsindex.Seurat.Clusters.2.html", sep="."))

################################################################################################################
################################################################################################################

# plot.data <- FetchData(object = samples.combined.list.combined, vars = c("UMAP_1", "UMAP_2", "UMAP_3", "orig.ident"))

# plot.data$label <- paste(rownames(plot.data))

# plot.data$label

# p = plot_ly(data = plot.data,
#        x = ~UMAP_1,
#        y = ~UMAP_2,
#        z = ~UMAP_3,
#        color = ~orig.ident,
#        type = "scatter3d",
#        mode = "markers",
#        marker = list(size = 5, width=2), # controls size of points
#        text = ~label,      # This is that extra column we made earlier for which we will use for cell ID
#        hoverinfo = "text") # When you visualize your plotly object, hovering your mouse pointer over a point shows cell names

# p %>% layout()

# htmlwidgets::saveWidget(p, paste(NAME, "htmlwidgetsindex.Orig.Ident.html", sep="."))

################################################################################################################
################################################################################################################
################################################################################################################
################################################################################################################
# MARKERS MULLER GLIA : Sox9, Glul, Clu, Dkk3, S100a6
# DefaultAssay(object = samples.combined.list.combined)

# DefaultAssay(object = samples.combined.list.combined) <- "RNA"
# colnames(samples.combined.list.combined)
# rownames(samples.combined.list.combined)

# DefaultAssay(object = samples.combined.list.combined) <- "integrated"
# DefaultAssay(object = samples.combined.list.combined) <- "SCT"

# about the MARKERS of MULLER GLIA :
# "Sox9"    %in% rownames(samples.combined.list.combined)
# "Glul"    %in% rownames(samples.combined.list.combined)
# "Clu"     %in% rownames(samples.combined.list.combined)
# "Dkk3"    %in% rownames(samples.combined.list.combined)
# "S100a6"  %in% rownames(samples.combined.list.combined)

################################################################################################################
################################################################################################################ as example all the genes in the LIST

# for (i in 1:dim(LIST.KNOWN.MARKERS)[1]) {
#############################################################################
#############################################################################
# CELL = LIST.KNOWN.MARKERS$CELL[i]
# GENE = LIST.KNOWN.MARKERS$MARKER[i]
#############################################################################
#############################################################################

# if (GENE %in% rownames(samples.combined.list.combined)) {

# plot.data <- FetchData(object = samples.combined.list.combined, vars = c("UMAP_1", "UMAP_2", "UMAP_3", GENE, "seurat_clusters"), slot = 'data')

# plot.data$changed <- ifelse(test = plot.data[,4] < 0.1, yes = plot.data[,4], no = 1)

# plot.data$label <- plot.data$seurat_clusters
# plot.data$label

# Plot your data, in this example my Seurat object had 21 clusters (0-20), and cells express a gene called ACTB
# p = plot_ly(data = plot.data,
#        x = ~UMAP_1, y = ~UMAP_2, z = ~UMAP_3,
#        color = ~changed, # you can just run this against the column for the gene as well using ~ACTB, the algorith will automatically scale in that case based on maximal and minimal values
#        opacity = .5,
#        colors = c('darkgreen', 'red'),
#        type = "scatter3d",
#        mode = "markers",
#        marker = list(size = 5, width=2),
#        text=~label,
#        hoverinfo="text")

# htmlwidgets::saveWidget(p, paste(NAME, "htmlwidgetsindex.display", CELL, GENE, "html", sep="."))
#
#  }
# }

################################################################################################################
################################################################################################################

save.image("integrated.reciprocalPCA.SEURAT3_RPCA_filter600.RData.after.ScaleData.for.figs.RData.after.ScaleData.with.fig3A.21nov2021.RData")

# save.image(file = paste(NAME, "after.plotly3D_1", "RData", sep="."))
################################################################################################################
################################################################################################################
